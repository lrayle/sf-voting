<html>

<!-- TODO: 
figure out why data is missing
-->

<head>
  <title>San Francisco voting patterns</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
  <!-- <link href = "https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css"
         rel = "stylesheet"> -->
  <!-- <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->
  <link rel="stylesheet" href="jquery-ui.css">
  <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
  <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
  <script src = "https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  
  <!-- files with json data -->
  <script src = "BallotPropositions_nimby2.js" type = "text/javascript"></script>
  <script src = "results_pre2012.min.js" type = "text/javascript"></script>
  <script src = "results_pre2002.min.js" type = "text/javascript"></script>
  <script src = "results_pre1992.min.js" type = "text/javascript"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style> 
  h1 {color: #888;font: 20px Arial, Helvetica, sans-serif;}
  p {color: #777;font: 16px Arial, Helvetica, sans-serif;}
  </style>
  <style>#slider-1 { margin: 1%; width: 95%;}  </style>
  <style>
    #map{ width: 95%; height: 85%; }
    .info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } .info h4 { margin: 0 0 5px; color: #777; }
    .legend{
    text-align: left;
    line-height: 20px;
    color: #555;
    }
    .legend i {width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7;}
  </style>

</head>
<body>
  <div id="map"></div>
  <div id = "slider-1"></div>
  <div><p id = "yearElec">Select an election</p></div> 
  <div id="vars">
    <input type="radio" id="pctNimby" name="var" value="Pct Nimby" checked="checked" /> 
    <label for="pctNimby">Pct Nimby</label>
    <input type="radio" id="medIncome" name="var" value="Med Income"> 
    <label for="medIncome">Med Income</label>
    <input type="radio" id="turnout" name="var" value="Turnout"> 
    <label for="turnout">Turnout</label>
  </div>


  <script type="text/javascript">

  //////// SLIDER SETUP /////
    // initial variable values. 
    // there are 22 elections. 
    var electionList = ["199603B","199706F","199711H","199806E","199806I","199806K","199911H","199911I","200011K","200011L","200111D","200203D","200403J","200611G","200806F","200806G","201311B","201311C","201406B","201411F","201511D","201511I"];

    ///// MAP SETUP ///// 

    // initialize the map, set center point and zoom level. 
    // Why don't we have to use new to instantiate a new object? Because there's a factory method, L.map()
    var map = L.map('map').setView([37.7654556,-122.4412955], 13);

    // load a tile layer
    // {z}/{x}/{y} refers to zoom, x-coord, y-coord. 
    L.tileLayer('https://api.mapbox.com/v4/{map_id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> Â© <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      map_id: 'mapbox.light',
      accessToken: 'pk.eyJ1IjoibHJheWxlIiwiYSI6ImNpZ3J2bmNydzAwNm91eWx4dmVoYWszcjEifQ.aehTtBfJxqjQhHm7ZzRK7w'}
      ).addTo(map);

    // Set inital variable values. 
    var varSelected = "Pct Nimby";
    var varId = "p";
    var grades = [0, .3, .45, .55, .7];


    var sliderValue = 0;
    var precLayer = getPrecinctYear(sliderValue);

    var precinctPolygons; // This will hold the precinct layer. 

    var election = "199603B";  // Value of selected selection
    $( "#yearElec" ).html(makeElecLabel(election));  // year

    $(document).ready(function(){

      // Layer for when page first loads. 
      precinctPolygons=L.geoJson(precLayer,{
        onEachFeature: onEachFeature,
        style: style,
        filter: function(feature, layer){
        return feature.properties.y == election;
        }
      }).addTo(map);
      legend.addTo(map);

      $( "#slider-1" ).slider({
         min: 0,
         max: 21,
         step: 1,
         value:0,  // starting value
         animate:"fast",
         orientation:"horizontal",
         slide: onSlider
      });

      function onSlider(event, ui){
        sliderValue = ui.value;
        election = electionList[sliderValue]; // get election year and prop
        $( "#yearElec" ).html(makeElecLabel(election));

        // find out what precinct layer to use. 
        precLayer = getPrecinctYear(sliderValue);
        
        console.log("slider value:"+sliderValue);
        console.log("election:"+election);

        // Change map layers. 
        map.removeLayer(precinctPolygons);

        precinctPolygons=L.geoJson(precLayer,{
          onEachFeature: onEachFeature,
          style: style,
          filter: function(feature, layer){
          return feature.properties.y == election;
          }
        }).addTo(map);
      };
      

      // Allow changing variables using radio buttons
      

      $("#vars").buttonset();
      $("#pctNimby").button();
      $("#medIncome").button();
      $("#turnout").button();
      
      $('#vars input').on('change', function() {
        varSelected=$("input[type='radio'][name='var']:checked").val();
        varId = getVariableLabel(varSelected);

        console.log('var selected:'+varSelected);
        // Change map layers. 
        map.removeLayer(precinctPolygons);

        precinctPolygons=L.geoJson(precLayer,{
          onEachFeature: onEachFeature,
          style: style,
          filter: function(feature, layer){
          return feature.properties.y == election;
          }
        }).addTo(map);
        legend.addTo(map);


      });
    });

      
    // This function gets the precinct year based on the slider value, which gives the index position in the electionList
    function getPrecinctYear(sV){
      return sV <= 11 ?  prec1992:
            sV <= 15 ?  prec2002:
            prec2012;
    }

    // This function gets the variable label given the button input
    // map:  "p":"pct_nimby","m":"med_inc_adj","t":"turnout","o":"owned","a":"precname"
    function getVariableLabel(v){
      return v == "Med Income" ?  "m":
            v == "Turnout" ?  "t":
            "p";
    }


    function makeElecLabel(elec){
      var month = propInfo[elec]["Month"];
      var yr = propInfo[elec]["Year"];
      var letter = propInfo[elec]["Letter"];
      var subject = propInfo[elec]["Subject"];
      var labelText = "<strong>"+ month+" "+yr+" Prop "+letter+"</strong> - "+subject;
      return labelText;
    }


  ///// MAP INTERACTIVITY
  // "p":"pct_nimby","m":"med_inc_adj","t":"turnout","o":"owned","a":"precname"}}
    function onEachFeature(feature, layer) {
          // Define which variable to display in popup, and give it a name. 
          //popupLine1 = varName+String(Number(feature.properties[varToPopup]).toFixed(2));  // use this to change the popup variable
          popupTitle = '<strong>PRECINCT '+ feature.properties["a"]+'</strong>';
          popupLine1 = 'Pct nimby: '+String(Number(parseFloat(feature.properties["p"]*100).toFixed(1)).toLocaleString('en'))+'%';
          popupLine2 = 'Med income: '+String(Number(parseFloat(feature.properties["m"]).toFixed(0)).toLocaleString('en'));
          popupLine3 = 'Turnout: '+String(Number(parseFloat(feature.properties["t"]*100).toFixed(1)).toLocaleString('en'))+'%';
          popupString = popupTitle+"<br>"+popupLine1+"<br>"+popupLine2+"<br>"+popupLine3;
          layer.bindPopup(popupString);

          layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight  

          })
          
      }
    
    // Define breaks based on variable selected.  v=varSelected
    function getGrades(v){
      return v=="Turnout" ? [0, .2, .35, .5, .65]:
          v=="Med Income" ? [0, 20000, 50000, 75000, 100000]:
          [0, .3, .45, .55, .7];

    };
    

    // This returns a color based on the given value
    function getColor(p, g) {
      
      var colors = ['#e66101','#fdb863','#f3e8ff','#b2abd2','#5e3c99'];
      return p > g[4] ?  colors[0]:
             p > g[3]  ? colors[1] :
             p > g[2]  ? colors[2]://'#f5f5f5' :
             p > g[1]  ? colors[3] :
             p > g[0]+.0001 ? colors[4]:
                          '#ffffff';
    };
    //This styles the data
    function style(feature) {
      grades = getGrades(varSelected);
      return {
          fillColor: getColor(feature.properties[varId], grades),
          weight: 1,
          opacity: 1,
          color: 'white',
          fillOpacity: 0.7
      };
    };

    // These functions will define what happens on mouseover
    function highlightFeature(e) {
      var layer = e.target;

      layer.setStyle({
          weight: 3,
          color: '#666',
          dashArray: '',
          fillOpacity: 0.7
      });

      // This brings the selected element to front, except for certain browsers that have problems with it.  
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
      }
    }
    
    function resetHighlight(e) {
      precinctPolygons.resetStyle(e.target);
    }

    
    // LEGEND // 

    var legend = L.control({position:'bottomright'})

    legend.onAdd = function (map) {
      grades = getGrades(varSelected);
      var div = L.DomUtil.create('div', 'info legend'),
          labels = ['<strong>'+ varSelected +'</strong>'],
          from, to;

      // loop through our density intervals and generate a label with a colored square for each interval
      if (varSelected=="Pct Nimby"|varSelected=="Turnout"){
        for (var i = 0; i < grades.length; i++) {

            from = grades[i];
            to = grades[i + 1];

            var from_label = String(Number(parseFloat(from*100).toFixed(0)).toLocaleString('en'));
            if(i!= grades.length-1){
              var to_label =String(Number(parseFloat(to*100).toFixed(0)).toLocaleString('en'))+'%';
            }else{var to_label=null};

            labels.push(
            '<i style="background:' + getColor(from + .01, grades) + '"></i> ' +
            from_label + (to_label ? '&ndash;' + to_label : '-100%'));
        
            div.innerHTML = labels.join('<br>');
        };
      }else if (varSelected=="Med Income"){
        // Need different formatting for different types of values. 
        for (var i = 0; i < grades.length; i++) {
            console.log(grades);
            from  = grades[i];
            to=grades[i+1];

            var from_label = String(Number(parseFloat(from).toFixed(0)).toLocaleString('en'));
            if(i!= grades.length-1){
              var to_label =String(Number(parseFloat(to).toFixed(0)).toLocaleString('en'));
            }else{var to_label=null};
            
            labels.push(
            '<i style="background:' + getColor((from + .01), grades) + '"></i> ' +
            from_label + (to_label !=null? '&ndash;' + to_label : '+'));

            div.innerHTML = labels.join('<br>');
        };
      }

      return div;
    };

    


  </script>
</body>
</html>